# Docker 环境配置说明

## 重要提示

在 Docker 环境中运行 MoonTV 时，容器内部无法自动获取宿主机的局域网 IP 地址。因此，需要配置 `SITE_BASE` 来指定访问地址。

## 配置方式

有两种方式配置 SITE_BASE：

### 方式一：在系统管理中配置（推荐）

1. 登录系统
2. 进入"系统管理"页面
3. 找到"站点配置"部分
4. 在"站点访问地址 (SITE_BASE)"输入框中填入宿主机 IP 地址，例如：`http://192.168.31.114:3000`
5. 点击"保存"按钮

**优点：**
- 无需重启服务，保存后立即生效
- 可以在 Web 界面中方便地修改
- 配置保存在数据库中，不会因为容器重启而丢失

### 方式二：在 .env 文件中配置

在项目根目录的 `.env` 文件中添加或修改 `SITE_BASE` 配置：

```env
# 站点配置
SITE_BASE=http://192.168.31.114:3000
```

将 `192.168.31.114` 替换为你的宿主机实际 IP 地址。

**注意：** 修改 .env 文件后需要重新启动服务才能生效。

## 配置优先级

如果同时配置了多个地方，优先级如下：
1. 环境变量 SITE_BASE（.env 文件）- 最高优先级
2. 数据库配置（系统管理中的设置）
3. 客户端传来的地址

## 获取宿主机 IP

### Windows:
```cmd
ipconfig
```
查找 "以太网适配器" 或 "无线局域网适配器" 下的 IPv4 地址

### Linux/Mac:
```bash
ip addr show
# 或
ifconfig
```

## 重新部署

### 如果修改了 .env 文件：

```bash
docker-compose down
docker-compose up
```

### 如果在系统管理中修改：

无需重启，保存后立即生效。

## 网络信息检查

部署完成后，可以通过以下方式检查配置是否正确：

1. 登录系统
2. 点击右上角用户菜单
3. 点击"订阅"按钮
4. 查看"网络信息"部分

如果配置正确，应该显示：
```
✅ 已配置环境变量 SITE_BASE，订阅链接将使用: http://192.168.31.114:3000
```
或
```
✅ 已在系统管理中配置 SITE_BASE，订阅链接将使用: http://192.168.31.114:3000
```

如果显示 Docker 容器内部 IP (172.x.x.x)，说明配置未生效，请检查：
- 配置的 IP 地址是否正确
- 是否保存了配置
- 如果修改了 .env 文件，是否重新启动了服务

## 常见问题

### Q: 为什么不能自动检测宿主机 IP？

A: Docker 容器运行在隔离的网络环境中，容器内部只能看到 Docker 网络的 IP (通常是 172.x.x.x)，无法直接获取宿主机的局域网 IP。

### Q: 如果宿主机 IP 变化了怎么办？

A: 
- 如果在系统管理中配置，直接在 Web 界面修改即可，无需重启
- 如果在 .env 文件中配置，需要更新 .env 文件并重新启动服务

建议：
- 在路由器中为宿主机设置静态 IP 地址
- 或使用 DHCP 保留功能固定 IP

### Q: 可以使用域名吗？

A: 可以。如果你有域名，可以配置为：
```env
SITE_BASE=https://your-domain.com
```

### Q: 外网访问怎么配置？

A: 如果需要外网访问：
1. 在路由器配置端口转发（3000 端口）
2. 获取公网 IP 或配置 DDNS
3. 配置 `SITE_BASE` 为公网地址：
   ```env
   SITE_BASE=http://your-public-ip:3000
   # 或
   SITE_BASE=https://your-domain.com
   ```

## 相关文件

- `.env` - 环境变量配置文件
- `src/lib/network-utils.ts` - 网络工具函数
- `src/app/api/network-info/route.ts` - 网络信息 API
- `src/app/api/tvbox/config/route.ts` - 订阅配置 API
- `src/app/admin/page.tsx` - 系统管理页面
