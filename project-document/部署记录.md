# MoonTV 部署记录

## 2025-12-28 添加系统管理中的 SITE_BASE 配置功能

### 功能描述
在系统管理界面添加"站点访问地址 (SITE_BASE)"配置项，允许管理员在 Web 界面中直接配置站点访问地址，无需修改 .env 文件和重启服务。

### 修改内容

#### 1. 前端修改
- **文件：** `src/app/admin/page.tsx`
  - 在 `SiteConfig` 接口中添加 `SiteBase?: string` 字段
  - 在站点配置表单中添加"站点访问地址"输入框
  - 添加配置说明：Docker 环境必须配置此项

#### 2. 后端 API 修改
- **文件：** `src/app/api/admin/site/route.ts`
  - 在请求参数中添加 `SiteBase` 字段处理
  - 在参数校验中添加 `SiteBase` 类型验证
  - 在保存配置时包含 `SiteBase` 字段

#### 3. 网络工具修改
- **文件：** `src/lib/network-utils.ts`
  - 修改 `getBestAccessURL` 函数，添加 `dbSiteBase` 参数
  - 调整优先级：环境变量 > 数据库配置 > 客户端地址

#### 4. API 集成
- **文件：** `src/app/api/tvbox/config/route.ts`
  - 从数据库读取 `SiteBase` 配置
  - 传递给 `getBestAccessURL` 函数
  
- **文件：** `src/app/api/network-info/route.ts`
  - 从数据库读取 `SiteBase` 配置
  - 在网络信息中显示数据库配置状态
  - 更新配置建议提示信息

#### 5. 文档更新
- **文件：** `.env.example`
  - 添加 `SITE_BASE` 配置示例
  
- **文件：** `project-document/Docker环境配置说明.md`
  - 添加系统管理配置方式说明
  - 更新配置优先级说明
  
- **文件：** `project-document/站点访问地址配置功能.md`
  - 新建功能说明文档

### 配置优先级
1. 环境变量 SITE_BASE（.env 文件）- 最高优先级
2. 数据库配置（系统管理界面）
3. 客户端传来的地址

### 使用方法
1. 登录系统管理页面
2. 找到"站点配置"部分
3. 在"站点访问地址 (SITE_BASE)"输入框中填入地址，例如：`http://192.168.31.114:3000`
4. 点击"保存"按钮
5. 刷新页面即可生效，无需重启服务

### 部署步骤
```bash
# 1. 停止旧服务
docker-compose down

# 2. 构建新镜像
docker-compose build moontv-core

# 3. 启动服务
docker-compose up
```

### 部署结果
- ✅ 系统管理界面成功添加 SITE_BASE 配置项
- ✅ 配置保存功能正常
- ✅ 订阅链接使用配置的地址
- ✅ 网络信息显示配置状态
- ✅ 所有服务正常运行

---

## 2025-12-28 修复 Docker 环境 IP 检测

### 问题描述
- Docker 容器内获取的是容器内部 IP (172.22.0.5)，而不是宿主机局域网 IP (192.168.31.114)
- 导致订阅链接和网络信息显示错误的地址

### 解决方案
1. 修改 `src/lib/network-utils.ts` 中的 `getBestAccessURL()` 函数
   - 优先使用 `SITE_BASE` 环境变量
   - 移除服务端自动检测局域网 IP 的逻辑（Docker 环境中不准确）
   - 使用客户端传来的地址作为备选

2. 修改 `src/app/api/network-info/route.ts` 中的 `getRecommendation()` 函数
   - 添加 Docker 环境检测（172.x.x.x 地址）
   - 提供清晰的配置提示信息
   - 使用 emoji 图标增强可读性

3. 配置 `.env` 文件
   ```env
   SITE_BASE=http://192.168.31.114:3000
   ```

### 部署步骤
```bash
# 1. 停止旧服务
docker-compose down

# 2. 构建新镜像
docker-compose build moontv-core

# 3. 启动服务
docker-compose up
```

### 部署结果
- ✅ moontv-core 服务启动成功 (端口 3000)
- ✅ moontv-kvrocks 服务运行正常
- ✅ danmu-api 服务运行正常 (端口 9321)
- ✅ pansou 服务运行正常 (端口 8081)
- ✅ 网络信息 API 正确显示配置的 SITE_BASE
- ✅ 订阅链接使用正确的宿主机 IP

### 访问地址
- 主应用: http://192.168.31.114:3000
- 弹幕 API: http://192.168.31.114:9321
- 盘搜服务: http://192.168.31.114:8081

---

## 2025-12-28 首次部署

### 部署内容
- 添加用户权限管理系统
- 实现自动 IP 检测与分享链接功能
- 创建完整的用户管理文档

### 部署步骤
```bash
docker-compose down
docker-compose build moontv-core
docker-compose up
```

### 部署结果
- ✅ 所有服务成功启动
- ✅ 用户管理功能正常
- ✅ 订阅功能正常
