# 站点访问地址配置功能

## 功能概述

为了解决 Docker 环境中无法自动获取宿主机 IP 的问题，系统提供了两种配置站点访问地址的方式：
1. 在系统管理界面中配置（推荐）
2. 在 .env 文件中配置环境变量

## 功能特点

- **灵活配置**：支持在 Web 界面和配置文件两种方式配置
- **即时生效**：在系统管理中修改后无需重启服务
- **优先级明确**：环境变量 > 数据库配置 > 客户端地址
- **智能提示**：自动检测 Docker 环境并提供配置建议

## 使用方法

### 方式一：在系统管理中配置（推荐）

1. 登录系统（使用管理员或站长账号）
2. 点击左侧菜单"系统管理"
3. 找到"站点配置"部分
4. 在"站点访问地址 (SITE_BASE)"输入框中填入完整的访问地址
   - 例如：`http://192.168.31.114:3000`
   - 或域名：`https://your-domain.com`
5. 点击"保存"按钮
6. 刷新页面使配置生效

**优点：**
- 无需重启服务
- 可以随时在 Web 界面修改
- 配置保存在数据库中，不会因容器重启而丢失

### 方式二：在 .env 文件中配置

在项目根目录的 `.env` 文件中添加：

```env
SITE_BASE=http://192.168.31.114:3000
```

**注意：** 修改后需要重启服务：
```bash
docker-compose down
docker-compose up
```

## 配置优先级

系统按以下优先级选择访问地址：

1. **环境变量 SITE_BASE**（最高优先级）
   - 在 .env 文件中配置
   - 适合固定配置，不需要经常修改的场景

2. **数据库配置**
   - 在系统管理界面中配置
   - 适合需要灵活调整的场景

3. **客户端地址**
   - 自动从浏览器请求中获取
   - 作为最后的备选方案

## 配置验证

配置完成后，可以通过以下方式验证：

1. 点击右上角用户菜单
2. 点击"订阅"按钮
3. 查看"网络信息"部分

**正确配置的提示：**
- `✅ 已配置环境变量 SITE_BASE，订阅链接将使用: http://192.168.31.114:3000`
- `✅ 已在系统管理中配置 SITE_BASE，订阅链接将使用: http://192.168.31.114:3000`

**需要配置的提示：**
- `⚠️ 检测到 Docker 容器环境 (172.x.x.x)，请在系统管理 → 站点配置中设置"站点访问地址"...`

## 应用场景

### 1. Docker 环境部署

Docker 容器内部只能看到容器网络 IP (172.x.x.x)，必须配置 SITE_BASE 为宿主机 IP。

**配置示例：**
```
http://192.168.31.114:3000
```

### 2. 局域网访问

如果只在局域网内使用，配置局域网 IP 即可。

**配置示例：**
```
http://192.168.1.100:3000
```

### 3. 外网访问

如果需要外网访问，配置公网 IP 或域名。

**配置示例：**
```
http://123.45.67.89:3000
https://moontv.example.com
```

### 4. 使用域名

如果有域名和 SSL 证书，可以配置 HTTPS 域名。

**配置示例：**
```
https://tv.yourdomain.com
```

## 技术实现

### 前端修改

**文件：** `src/app/admin/page.tsx`

1. 在 `SiteConfig` 接口中添加 `SiteBase` 字段
2. 在站点配置表单中添加输入框
3. 在状态初始化和更新中处理 `SiteBase`

### 后端修改

**文件：** `src/app/api/admin/site/route.ts`

1. 在请求参数中添加 `SiteBase` 字段
2. 在参数校验中验证 `SiteBase` 类型
3. 在保存配置时包含 `SiteBase`

### 网络工具修改

**文件：** `src/lib/network-utils.ts`

修改 `getBestAccessURL` 函数：
- 添加 `dbSiteBase` 参数
- 调整优先级：环境变量 > 数据库配置 > 客户端地址

### API 集成

**文件：**
- `src/app/api/tvbox/config/route.ts` - 订阅配置 API
- `src/app/api/network-info/route.ts` - 网络信息 API

在这些 API 中：
1. 从数据库读取 `SiteBase` 配置
2. 传递给 `getBestAccessURL` 函数
3. 在网络信息中显示配置状态

## 相关文件

- `src/app/admin/page.tsx` - 系统管理页面
- `src/app/api/admin/site/route.ts` - 站点配置 API
- `src/lib/network-utils.ts` - 网络工具函数
- `src/app/api/tvbox/config/route.ts` - 订阅配置 API
- `src/app/api/network-info/route.ts` - 网络信息 API
- `.env` - 环境变量配置文件
- `.env.example` - 环境变量示例文件

## 注意事项

1. **配置格式**：必须包含协议（http:// 或 https://）和端口号
2. **IP 变化**：如果宿主机 IP 变化，需要更新配置
3. **重启要求**：
   - 在系统管理中修改：无需重启
   - 修改 .env 文件：需要重启服务
4. **优先级**：环境变量优先级最高，会覆盖数据库配置

## 常见问题

### Q: 修改后没有生效？

A: 
- 如果在系统管理中修改，点击保存后刷新页面
- 如果修改 .env 文件，需要重启服务：`docker-compose down && docker-compose up`

### Q: 应该用哪种方式配置？

A: 
- **推荐使用系统管理界面配置**：方便、无需重启、不会因容器重启丢失
- 如果需要固定配置且不常修改，可以使用 .env 文件

### Q: 可以同时配置两个地方吗？

A: 可以，但环境变量优先级更高，会覆盖数据库配置。

### Q: 配置错误会有什么影响？

A: 订阅链接会使用错误的地址，导致 TVBox 等客户端无法访问。建议配置后在网络信息中验证。
